var http = require('http');
var fs = require('fs');
var url = require('url');
const { parse } = require('querystring');
const { type } = require('os');

//var sendmail = require('sendmail')({silent: true});
const nodemailer = require('nodemailer');


let http_handler = (req,res)=>{
    res.writeHead(200,{'Content-Type':'text/html; charset=utf-8'});
    if(url.parse(req.url).pathname=='/' && req.method == 'GET')
    {
        res.end(fs.readFileSync('./06-02.html'));
    }
    else if(url.parse(req.url).pathname=='/' && req.method == 'POST')
    {
        let body = '';
        req.on('data',chunk => {body += chunk.toString();});
        req.on('end',()=>{
            let parm = parse(body);
            
            const transporter = nodemailer.createTransport({
                host: 'smtp.mail.ru',
                port: 465,
                secure: true,
                auth: {
                    user: 'dnsmnv06@mail.ru',
                    pass: '0w5nUc5FiirTiJ1u3yiu',
                },});
            
            // sendmail({
            //      from: parm.sender,
            //      to: parm.reciver,
            //      subject: 'test sendmail',
            //      html:parm.message
            //  }, function(err, reply)
            //  {
            //      console.log(err && err.stack);
            //      console.log(reply);
            //  });

            const options = {
                from: parm.sender,
                to: parm.receiver,
                subject: "Lab05",
                text: parm.message,
            };

            transporter.sendMail(options, (err, info) => {
                if (err) {
                    console.log(err);
                    res.end(`<h1>Error: ${err.message}</h1>`)
                } else {
                    console.log(info);
                    res.end(`<h1>OK: ${parm.receiver}, ${parm.sender}, ${parm.message}</h1>`);
                }
            });

          //  res.end(`<h1>OK: ${parm.reciver}, ${parm.sender}, ${parm.message}</h1>`)
        })
    }
    else 
        res.end('<h1>Not supported</h1>');
}

let server = http.createServer(http_handler);
server.listen(3000);

console.log('Server running at http://localhost:3000/')